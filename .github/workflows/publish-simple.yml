name: Simple NPM Publish

on:
  workflow_dispatch:
    inputs:
      npm_tag:
        description: 'npm dist-tag (latest, beta, next, etc.)'
        required: false
        default: 'latest'
      dry_run:
        description: 'Dry run (test without publishing)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  simple-publish:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'
        registry-url: 'https://registry.npmjs.org'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run full validation
      run: |
        echo "ğŸ” Running validation pipeline..."
        npm run type-check
        npm run lint
        npm run test:ci
        npm run build
        echo "âœ… All validation checks passed"
        
    - name: Verify build output
      run: |
        echo "ğŸ” Verifying build output..."
        ls -la dist/
        test -f dist/index.js || (echo "âŒ dist/index.js not found" && exit 1)
        test -f dist/cli.js || (echo "âŒ dist/cli.js not found" && exit 1)
        echo "âœ… Build verification passed"
        
    - name: Test package locally
      run: |
        echo "ğŸ§ª Testing package installation..."
        npm pack
        PACKAGE_FILE=$(ls *.tgz)
        echo "Testing local installation of $PACKAGE_FILE"
        npm install -g "$PACKAGE_FILE"
        context-mcp --help
        echo "âœ… Package installation test passed"
        
    - name: Show package info
      run: |
        echo "ğŸ“¦ Package Information:"
        npm pkg get name version description
        echo ""
        echo "ğŸ“‹ Files to be published:"
        npm pack --dry-run
        
    - name: Dry run publish
      if: inputs.dry_run
      run: |
        echo "ğŸ§ª Dry run mode - testing publish without actually publishing"
        npm publish --dry-run --tag=${{ inputs.npm_tag }}
        echo "âœ… Dry run completed successfully"
        echo ""
        echo "â„¹ï¸  To publish for real, run this workflow again with dry_run=false"
        
    - name: Publish to npm
      if: '!inputs.dry_run'
      run: |
        echo "ğŸš€ Publishing to npm..."
        npm publish --tag=${{ inputs.npm_tag }}
        echo "âœ… Published successfully!"
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        
    - name: Verify npm publication
      if: '!inputs.dry_run'
      run: |
        echo "ğŸ” Verifying npm publication..."
        sleep 10
        PACKAGE_NAME=$(npm pkg get name | tr -d '"')
        PACKAGE_VERSION=$(npm pkg get version | tr -d '"')
        npm view "$PACKAGE_NAME@$PACKAGE_VERSION" version
        echo "âœ… Package successfully published to npm registry"
        echo ""
        echo "ğŸ“‹ Installation command:"
        echo "npm install -g $PACKAGE_NAME"
